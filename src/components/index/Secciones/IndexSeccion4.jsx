import React, { useEffect, useRef } from 'react';
import { useStore } from '@nanostores/react';
import { isEnglish } from '../../../data/variables';
import styles from '../css/indexSeccion4.module.css';
import Button from '../../global/Button';
import { gsap } from 'gsap';
import { ScrollTrigger } from 'gsap/ScrollTrigger';

// ReactBits Animations - Full arsenal
import BlurText from '../../global/animations/BlurText/BlurText';
import ShinyText from '../../global/animations/ShinyText/ShinyText';
import GradientText from '../../global/animations/GradientText/GradientText';
import ScrollReveal from '../../global/animations/ScrollReveal/ScrollReveal';
import CountUp from '../../global/animations/CountUp';
import CurvedLoop from '../../global/animations/CurvedLoop/CurvedLoop';

gsap.registerPlugin(ScrollTrigger);

const IndexSeccion4 = () => {
  const ingles = useStore(isEnglish);
  const sectionRef = useRef(null);
  const contentRef = useRef(null);
  const panelsRef = useRef([]);

  const content = {
    es: {
      // Panel 1 - Introducción épica
      intro: {
        tag: "LA IDOL DE MAGIC DRINK",
        title: "Hexy",
        subtitle: "DJ Sweet Hex",
        description: "La voz que conquistó millones de corazones"
      },
      // Panel 2 - El misterio
      mystery: {
        title: "¿Quién es DJ Sweet Hex?",
        text: "Nadie sabe con certeza quién está detrás del nombre. Algunos dicen que es una productora anónima, otros creen que es un equipo creativo entero.",
        highlight: "El misterio es parte de la magia."
      },
      // Panel 3 - Los números
      stats: {
        title: "Los números hablan",
        items: [
          { value: 5, suffix: "B+", label: "Streams globales", icon: "🎵", accentColor: "#FF6AD7" },
          { value: 40, suffix: "+", label: "Países con campañas", icon: "🌍", accentColor: "#82D2FF" },
          { value: 1, prefix: "#", suffix: "", label: "Idol del Magic Drink Day", icon: "👑", accentColor: "#F9F871" }
        ]
      },
      // Panel 4 - La experiencia
      experience: {
        title: "Música + Sabor",
        text: "Cuando su música suena y una Magic Drink se abre, el mundo se siente un poco más brillante.",
        cta: "Escuchar a Hexy",
        ctaSecondary: "Ver discografía"
      }
    },
    en: {
      intro: {
        tag: "THE MAGIC DRINK IDOL",
        title: "Hexy",
        subtitle: "DJ Sweet Hex",
        description: "The voice that conquered millions of hearts"
      },
      mystery: {
        title: "Who is DJ Sweet Hex?",
        text: "No one knows for sure who is behind the name. Some say it's an anonymous producer, others believe it's an entire creative team.",
        highlight: "The mystery is part of the magic."
      },
      stats: {
        title: "Numbers speak",
        items: [
          { value: 5, suffix: "B+", label: "Global streams", icon: "🎵", accentColor: "#FF6AD7" },
          { value: 40, suffix: "+", label: "Countries with campaigns", icon: "🌍", accentColor: "#82D2FF" },
          { value: 1, prefix: "#", suffix: "", label: "Magic Drink Day idol", icon: "👑", accentColor: "#F9F871" }
        ]
      },
      experience: {
        title: "Music + Flavor",
        text: "When her music plays and a Magic Drink opens, the world feels a little brighter.",
        cta: "Listen to Hexy",
        ctaSecondary: "View discography"
      }
    }
  };

  const t = ingles ? content.en : content.es;

  // Animaciones GSAP para los paneles
  useEffect(() => {
    const section = sectionRef.current;
    const panels = panelsRef.current;
    
    if (!section || panels.length === 0) return;

    let ctx;
    let rafId;

    const initAnimations = () => {
      ctx = gsap.context(() => {
        // Animar cada panel cuando entra en viewport
        panels.forEach((panel, index) => {
          if (!panel) return;

          // Animación de entrada del panel
          gsap.fromTo(panel,
            { 
              opacity: 0, 
              y: 80,
              scale: 0.95
            },
            {
              opacity: 1,
              y: 0,
              scale: 1,
              duration: 1,
              ease: "power3.out",
              scrollTrigger: {
                trigger: panel,
                start: "top 85%",
                end: "top 40%",
                toggleActions: "play none none reverse",
              }
            }
          );

          // Animación de parallax sutil para elementos internos
          const innerElements = panel.querySelectorAll(`.${styles.animateIn}`);
          innerElements.forEach((el, i) => {
            gsap.fromTo(el,
              { opacity: 0, y: 40 },
              {
                opacity: 1,
                y: 0,
                duration: 0.8,
                delay: i * 0.1,
                ease: "power2.out",
                scrollTrigger: {
                  trigger: panel,
                  start: "top 80%",
                  toggleActions: "play none none reverse",
                }
              }
            );
          });
        });

        // Efecto parallax en Hexy
        const hexyImage = section.querySelector(`.${styles.hexyImage}`);
        if (hexyImage) {
          gsap.to(hexyImage, {
            yPercent: -15,
            ease: "none",
            scrollTrigger: {
              trigger: section,
              start: "top bottom",
              end: "bottom top",
              scrub: 1
            }
          });
        }

      }, section);
    };

    // Esperar al layout
    rafId = requestAnimationFrame(() => {
      setTimeout(initAnimations, 100);
    });

    return () => {
      if (rafId) cancelAnimationFrame(rafId);
      if (ctx) ctx.revert();
    };
  }, []);

  // Función para agregar refs a los paneles
  const addPanelRef = (el, index) => {
    panelsRef.current[index] = el;
  };

  return (
    <section ref={sectionRef} className={styles.section}>
      {/* Background decorativo */}
      <div className={styles.backgroundDecor}>
        <div className={styles.gradientOrb1}></div>
        <div className={styles.gradientOrb2}></div>
        <div className={styles.noiseOverlay}></div>
      </div>

      {/* Notas musicales flotantes */}
      <div className={styles.musicNotes} aria-hidden="true">
        {['♪', '♫', '♪', '♫', '✦', '♪'].map((note, i) => (
          <span key={i} className={styles.note} style={{ '--i': i }}>{note}</span>
        ))}
      </div>

      <div className={styles.container}>
        {/* ═══════════════════════════════════════════════════════════════
            COLUMNA IZQUIERDA - Hexy Sticky
        ═══════════════════════════════════════════════════════════════ */}
        <div className={styles.stickyColumn}>
          <div className={styles.hexyWrapper}>
            {/* Glow de fondo */}
            <div className={styles.hexyGlow}></div>
            
            {/* Anillos decorativos orbitales */}
          {/*   <div className={styles.hexyRings}>
              <div className={styles.ring1}></div>
              <div className={styles.ring2}></div>
            </div> */}
            
            {/* Imagen de Hexy */}
            <img
              src="/image/hexy/hexy-highlight.png"
              alt="Hexy - DJ Sweet Hex"
              className={styles.hexyImage}
            />
            
            {/* Badge flotante */}
            <div className={styles.hexyBadge}>
              <span>✨</span>
            </div>

            {/* Partículas */}
            <div className={styles.particles}>
              {[...Array(8)].map((_, i) => (
                <span 
                  key={i} 
                  className={styles.particle}
                  style={{ '--i': i }}
                >✦</span>
              ))}
            </div>
          </div>
        </div>

        {/* ═══════════════════════════════════════════════════════════════
            COLUMNA DERECHA - Contenido con scroll
        ═══════════════════════════════════════════════════════════════ */}
        <div ref={contentRef} className={styles.contentColumn}>
          
          {/* Panel 1: Introducción */}
          <div ref={(el) => addPanelRef(el, 0)} className={styles.panel}>
            <div className={styles.panelInner}>
              <span className={`${styles.tag} ${styles.animateIn}`}>
                <ShinyText
                  text={t.intro.tag}
                  speed={3}
                  color="rgba(255,255,255,0.7)"
                  shineColor="#FF6AD7"
                />
              </span>
              <h2 className={`${styles.heroTitle} ${styles.animateIn}`}>
                <BlurText
                  text={t.intro.title}
                  delay={100}
                  animateBy="letters"
                  direction="bottom"
                  className={styles.heroTitleText}
                />
              </h2>
              <p className={`${styles.heroSubtitle} ${styles.animateIn}`}>
                <GradientText
                  colors={["#AA37F2", "#FF6AD7", "#82D2FF", "#AA37F2"]}
                  animationSpeed={4}
                  showBorder={false}
                >
                  {t.intro.subtitle}
                </GradientText>
              </p>
              <p className={`${styles.heroDescription} ${styles.animateIn}`}>
                {t.intro.description}
              </p>
            </div>
          </div>

          {/* Panel 2: El Misterio */}
          <div ref={(el) => addPanelRef(el, 1)} className={styles.panel}>
            <div className={styles.panelInner}>
              <h3 className={`${styles.sectionTitle} ${styles.animateIn}`}>
                <ScrollReveal
                  enableBlur={true}
                  baseOpacity={0.15}
                  blurStrength={6}
                  containerClassName={styles.scrollRevealContainer}
                  textClassName={styles.mysteryTitleText}
                >
                  {t.mystery.title}
                </ScrollReveal>
              </h3>
              <p className={`${styles.mysteryText}`}>
                {t.mystery.text}
              </p>
              <blockquote className={`${styles.highlight} ${styles.animateIn}`}>
                <span className={styles.quoteIcon}>"</span>
                <ShinyText
                  text={t.mystery.highlight}
                  speed={2}
                  color="#F9F871"
                  shineColor="#ffffff"
                />
              </blockquote>
            </div>
          </div>

          {/* Panel 3: Stats - EPIC VERSION */}
          <div ref={(el) => addPanelRef(el, 2)} className={styles.panel}>
            <div className={styles.panelInner}>
              <h3 className={`${styles.sectionTitle} ${styles.animateIn}`}>
                <ScrollReveal
                  enableBlur={true}
                  baseOpacity={0.15}
                  blurStrength={5}
                  containerClassName={styles.scrollRevealContainer}
                  textClassName={styles.statsTitleText}
                >
                  {t.stats.title}
                </ScrollReveal>
              </h3>
              <div className={styles.statsGrid}>
                {t.stats.items.map((stat, index) => (
                  <div 
                    key={index} 
                    className={`${styles.statCard} ${styles.animateIn}`}
                    style={{ 
                      '--delay': `${index * 0.1}s`,
                      '--accent-color': stat.accentColor 
                    }}
                  >
                    {/* Icon Badge */}
                    <div className={styles.statIconBadge}>
                      <span className={styles.statIcon}>{stat.icon}</span>
                      <div className={styles.statIconGlow}></div>
                    </div>
                    
                    {/* Value with CountUp */}
                    <span className={styles.statValue}>
                      <GradientText
                        colors={["#FF6AD7", "#AA37F2", "#82D2FF", "#F9F871", "#FF6AD7"]}
                        animationSpeed={3}
                        showBorder={false}
                      >
                        {stat.prefix || ''}
                        <CountUp
                          to={stat.value}
                          from={0}
                          duration={2.5}
                          separator=","
                        />
                        {stat.suffix}
                      </GradientText>
                    </span>
                    
                    {/* Label with accent bar */}
                    <div className={styles.statLabelWrapper}>
                      <span className={styles.statAccentBar}></span>
                      <span className={styles.statLabel}>{stat.label}</span>
                    </div>
                    
                    {/* Decorative sparkle */}
                    <span className={styles.statSparkle}>✦</span>
                  </div>
                ))}
              </div>
            </div>
          </div>

          {/* Panel 4: Experiencia + CTA */}
          <div ref={(el) => addPanelRef(el, 3)} className={styles.panel}>
            <div className={styles.panelInner}>
              <h3 className={`${styles.sectionTitle} ${styles.animateIn}`}>
                <GradientText
                  colors={["#FF6AD7", "#F9F871", "#82D2FF", "#FF6AD7"]}
                  animationSpeed={5}
                  showBorder={false}
                  className={styles.experienceTitleGradient}
                >
                  {t.experience.title}
                </GradientText>
              </h3>
              <p className={`${styles.experienceText} ${styles.animateIn}`}>
                {t.experience.text}
              </p>
              <div className={`${styles.ctaGroup} ${styles.animateIn}`}>
                <Button
                  textEs={t.experience.cta}
                  textEn={t.experience.cta}
                  href="/hexy"
                  variant="magic"
                  size="lg"
                  showArrow={true}
                />
                <Button
                  textEs={t.experience.ctaSecondary}
                  textEn={t.experience.ctaSecondary}
                  href="/hexy"
                  variant="secondary"
                  size="lg"
                />
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* ═══════════════════════════════════════════════════════════════
          CURVED LOOP - Magic Drink Banner
      ═══════════════════════════════════════════════════════════════ */}
      <div className={styles.curvedLoopWrapper}>
        <CurvedLoop
          marqueeText={ingles ? "MUSIC & FLAVOR  ♫  FEEL THE MAGIC  ♪ " : "MUSICA Y SABOR  ♫  SIENTE LA MAGIA  ♪ "}
          speed={1.5}
          curveAmount={250}
          direction="left"
          interactive={false}
          className={styles.curvedLoopText}
        />
      </div>
    </section>
  );
};

export default IndexSeccion4;
