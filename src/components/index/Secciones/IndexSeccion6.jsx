import React, { useEffect, useRef, useState } from 'react';
import { useStore } from '@nanostores/react';
import { isEnglish } from '../../../data/variables';
import styles from '../css/indexSeccion6.module.css';
import Button from '../../global/Button';
import GradientText from '../../global/animations/GradientText/GradientText';
import CountUp from '../../global/animations/CountUp';
import { gsap } from 'gsap';
import { ScrollTrigger } from 'gsap/ScrollTrigger';

gsap.registerPlugin(ScrollTrigger);

const IndexSeccion6 = () => {
  const ingles = useStore(isEnglish);
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CONTENIDO - Objeto de traducciones (patrÃ³n estÃ¡ndar)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const content = {
    es: {
      title: "Wonderpop Plaza",
      tagline: "El corazÃ³n oficial de Magic Drink",
      subtitle: "MÃ¡s que una tienda. Un mundo Magic Drink.",
      description: "Wonderpop Plaza es el centro comercial oficial de Magic Drink. Un espacio donde la bebida, la mÃºsica y la creatividad se encuentran. AquÃ­ nacen ediciones especiales, eventos exclusivos y experiencias Ãºnicas.",
      highlightsTitle: "Todo lo que encontrarÃ¡s",
      highlights: [
        { icon: '/icons/icono_lata.png', text: 'Tienda oficial Magic Drink' },
        { icon: '/icons/icono_gorro.png', text: 'MÃºsica y experiencias de Hexy' },
        { icon: '/icons/icono_bolsa.png', text: 'Merch exclusivo y ediciones limitadas' },
        { icon: '/icons/icono_globo.png', text: 'Eventos especiales durante el Magic Drink Day' }
      ],
      cta: "Explorar Wonderpop Plaza",
      statsTitle: "Nuestro Impacto Global",
      stats: [
        { value: 24, suffix: '', label: 'Ubicaciones globales', icon: 'ğŸŒ' },
        { value: 2, suffix: 'M+', label: 'Visitantes mensuales', icon: 'ğŸ‘¥' },
        { value: 4.9, suffix: '', label: 'CalificaciÃ³n promedio', icon: 'ğŸ’«', hasStar: true },
        { value: 500, suffix: 'K+', label: 'Fotos compartidas', icon: 'ğŸ“¸' }
      ]
    },
    en: {
      title: "Wonderpop Plaza",
      tagline: "The official heart of Magic Drink",
      subtitle: "More than a store. A Magic Drink world.",
      description: "Wonderpop Plaza is the official shopping center of Magic Drink. A space where the drink, music and creativity meet in one place. Here special editions are born, exclusive events and unique experiences.",
      highlightsTitle: "Everything you'll find",
      highlights: [
        { icon: '/icons/icono_lata.png', text: 'Official Magic Drink Store' },
        { icon: '/icons/icono_gorro.png', text: 'Music and Hexy experiences' },
        { icon: '/icons/icono_bolsa.png', text: 'Exclusive merch and limited editions' },
        { icon: '/icons/icono_globo.png', text: 'Special events during Magic Drink Day' }
      ],
      cta: "Explore Wonderpop Plaza",
      statsTitle: "Our Global Impact",
      stats: [
        { value: 24, suffix: '', label: 'Global locations', icon: 'ğŸŒ' },
        { value: 2, suffix: 'M+', label: 'Monthly visitors', icon: 'ğŸ‘¥' },
        { value: 4.9, suffix: '', label: 'Average rating', icon: 'ğŸ’«', hasStar: true },
        { value: 500, suffix: 'K+', label: 'Photos shared', icon: 'ğŸ“¸' }
      ]
    }
  };

  const t = ingles ? content.en : content.es;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // REFS PARA GSAP
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const sectionRef = useRef(null);
  const titleRef = useRef(null);
  const particlesRef = useRef(null);
  const videoWrapperRef = useRef(null);
  const videoRef = useRef(null);
  
  // Fase 1: Intro (subtÃ­tulo + descripciÃ³n)
  const introContentRef = useRef(null);
  
  // Fase 2: Highlights + CTA
  const highlightsContainerRef = useRef(null);
  const highlightItemsRef = useRef([]);
  const ctaRef = useRef(null);
  
  // Fase 3: Stats
  const statsContainerRef = useRef(null);
  const statCardsRef = useRef([]);

  // Estado para activar CountUp
  const [statsVisible, setStatsVisible] = useState(false);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // TIMELINE CINEMÃTICO - Contenido en racimos/fases
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  useEffect(() => {
    const section = sectionRef.current;
    const title = titleRef.current;
    const particles = particlesRef.current;
    const videoWrapper = videoWrapperRef.current;
    const video = videoRef.current;
    const introContent = introContentRef.current;
    const highlightsContainer = highlightsContainerRef.current;
    const cta = ctaRef.current;
    const statsContainer = statsContainerRef.current;

    if (!section || !video || !title) return;

    let ctx;
    let rafId;

    const initCinematicTimeline = () => {
      const waitForVideo = new Promise((resolve) => {
        if (video.readyState >= 2) {
          resolve();
        } else {
          video.addEventListener('loadeddata', resolve, { once: true });
          setTimeout(resolve, 3000);
        }
      });

      waitForVideo.then(() => {
        video.pause();
        video.currentTime = 0;
        
        const videoDuration = video.duration || 10;

        ctx = gsap.context(() => {
          
          const tl = gsap.timeline({
            scrollTrigger: {
              trigger: section,
              start: "top top",
              end: "+=550%",
              pin: true,
              scrub: 0.8,
              anticipatePin: 1,
              onUpdate: (self) => {
                const progress = self.progress;
                
                // Video scrub: 12% - 72%
                if (progress >= 0.12 && progress <= 0.72) {
                  const videoProgress = (progress - 0.12) / 0.60;
                  const targetTime = videoProgress * videoDuration;
                  
                  if (Math.abs(video.currentTime - targetTime) > 0.02) {
                    video.currentTime = targetTime;
                  }
                }

                // Activar stats CountUp al 80%
                if (progress >= 0.80 && !statsVisible) {
                  setStatsVisible(true);
                }
              }
            }
          });

          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // FASE 1: TÃTULO ZOOM-IN (0% - 10%)
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          tl.fromTo(title,
            { scale: 0.15, opacity: 0, filter: "blur(25px)" },
            { scale: 1, opacity: 1, filter: "blur(0px)", duration: 0.10, ease: "back.out(1.4)" },
            0
          );

          // PartÃ­culas aparecen con fade-in despuÃ©s del tÃ­tulo
          if (particles) {
            tl.fromTo(particles,
              { opacity: 0 },
              { opacity: 1, duration: 0.08, ease: "power2.out" },
              0.06
            );
          }

          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // FASE 2: TÃTULO SE REDUCE Y SUBE (10% - 15%)
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          tl.to(title,
            { scale: 0.35, y: "-38vh", duration: 0.05, ease: "power2.inOut" },
            0.10
          );

          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // FASE 3: VIDEO APARECE CENTRADO (12% - 22%)
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          tl.fromTo(videoWrapper,
            { opacity: 0, scale: 0.75, y: 80 },
            { opacity: 1, scale: 1, y: 0, duration: 0.10, ease: "power2.out" },
            0.12
          );

          tl.fromTo(video,
            { filter: "blur(30px) brightness(0.5)" },
            { filter: "blur(0px) brightness(1)", duration: 0.10, ease: "power2.out" },
            0.12
          );

          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // FASE 4: INTRO CONTENT APARECE (22% - 32%)
          // SubtÃ­tulo + descripciÃ³n aparecen debajo del video
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          if (introContent) {
            tl.fromTo(introContent,
              { opacity: 0, y: 60, filter: "blur(12px)" },
              { opacity: 1, y: 0, filter: "blur(0px)", duration: 0.10, ease: "power2.out" },
              0.22
            );
          }

          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // FASE 5: INTRO DESAPARECE (38% - 45%)
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          if (introContent) {
            tl.to(introContent,
              { opacity: 0, y: -40, filter: "blur(10px)", duration: 0.07, ease: "power2.in" },
              0.38
            );
          }

          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // FASE 6: HIGHLIGHTS APARECEN UNO A UNO (45% - 62%)
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          if (highlightsContainer) {
            tl.fromTo(highlightsContainer,
              { opacity: 0, y: 40 },
              { opacity: 1, y: 0, duration: 0.05 },
              0.45
            );
          }

          const highlightItems = highlightItemsRef.current.filter(Boolean);
          highlightItems.forEach((item, index) => {
            tl.fromTo(item,
              { opacity: 0, x: 100, scale: 0.8 },
              { opacity: 1, x: 0, scale: 1, duration: 0.04, ease: "back.out(1.3)" },
              0.48 + (index * 0.03)
            );
          });

          // CTA aparece despuÃ©s de highlights
          if (cta) {
            tl.fromTo(cta,
              { opacity: 0, y: 40, scale: 0.85 },
              { opacity: 1, y: 0, scale: 1, duration: 0.05, ease: "back.out(1.4)" },
              0.62
            );
          }

          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // FASE 7: PAUSA - TODO VISIBLE (62% - 72%)
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          tl.to({}, { duration: 0.10 }, 0.62);

          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // FASE 8: TODO DESAPARECE (72% - 80%)
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          tl.to([videoWrapper, highlightsContainer, title],
            { opacity: 0, y: -60, scale: 0.9, filter: "blur(12px)", duration: 0.08, ease: "power2.in" },
            0.72
          );

          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // FASE 9: STATS APARECEN (80% - 100%)
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          if (statsContainer) {
            tl.fromTo(statsContainer,
              { opacity: 0, y: 100, scale: 0.8, pointerEvents: 'none' },
              { opacity: 1, y: 0, scale: 1, pointerEvents: 'auto', duration: 0.10, ease: "power2.out" },
              0.80
            );
          }

          const statCards = statCardsRef.current.filter(Boolean);
          statCards.forEach((card, index) => {
            tl.fromTo(card,
              { opacity: 0, y: 80, scale: 0.7, rotateY: 20 },
              { opacity: 1, y: 0, scale: 1, rotateY: 0, duration: 0.06, ease: "back.out(1.3)" },
              0.84 + (index * 0.03)
            );
          });

        }, section);
      });
    };

    rafId = requestAnimationFrame(() => {
      setTimeout(initCinematicTimeline, 150);
    });

    return () => {
      if (rafId) cancelAnimationFrame(rafId);
      if (ctx) ctx.revert();
    };
  }, [statsVisible]);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RENDER
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  return (
    <section ref={sectionRef} className={styles.wonderpopSection}>
      {/* Fondo sÃ³lido */}
      <div className={styles.darkBackground}></div>

      {/* PartÃ­culas decorativas */}
      <div ref={particlesRef} className={styles.particles}>
        {Array.from({ length: 12 }).map((_, i) => (
          <div key={i} className={styles.particle}></div>
        ))}
      </div>

      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          TÃTULO WONDERPOP PLAZA
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
      <div ref={titleRef} className={styles.heroTitle}>
        <h2 className={styles.titleText}>
          <GradientText
            colors={['#FF6AD7', '#AA37F2', '#82D2FF', '#F9F871', '#FF6AD7']}
            animationSpeed={6}
            className={styles.gradientTitle}
          >
            âœ¨ {t.title} âœ¨
          </GradientText>
        </h2>
        <p className={styles.tagline}>{t.tagline}</p>
      </div>

      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          LAYOUT CENTRAL: VIDEO + CONTENIDO EN FASES
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
      <div className={styles.mainLayout}>
        
        {/* Video centrado */}
        <div ref={videoWrapperRef} className={styles.videoWrapper}>
          <div className={styles.videoBorder}></div>
          <video 
            ref={videoRef}
            className={styles.video}
            muted
            playsInline
            preload="auto"
            poster="/image/wonderpop/wonderpop-poster.png"
          >
            <source src="/videos/wonderpop.mp4" type="video/mp4" />
          </video>
        </div>

        {/* FASE 1: Intro Content (debajo del video) */}
        <div ref={introContentRef} className={styles.introContent}>
          <h3 className={styles.subtitle}>{t.subtitle}</h3>
          <p className={styles.description}>{t.description}</p>
        </div>

        {/* FASE 2: Highlights Container (reemplaza intro) */}
        <div ref={highlightsContainerRef} className={styles.highlightsContainer}>
          <h4 className={styles.highlightsTitle}>{t.highlightsTitle}</h4>
          <ul className={styles.highlights}>
            {t.highlights.map((item, index) => (
              <li 
                key={index}
                ref={el => highlightItemsRef.current[index] = el}
                className={styles.highlightItem}
              >
                <div className={styles.iconWrapper}>
                  <img src={item.icon} alt="" className={styles.icon} loading="lazy" />
                </div>
                <span className={styles.highlightText}>{item.text}</span>
              </li>
            ))}
          </ul>
          
          <div ref={ctaRef} className={styles.ctaWrapper}>
            <Button 
              href="/wonderpop"
              textEs={content.es.cta}
              textEn={content.en.cta}
              variant="magic"
              size="lg"
              icon=""
              showArrow={true}
            />
          </div>
        </div>

      </div>

      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          STATS GRID - Aparece al final
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
      <div ref={statsContainerRef} className={styles.statsContainer}>
        <h3 className={styles.statsTitle}>
          <GradientText
            colors={['#FF6AD7', '#AA37F2', '#82D2FF']}
            animationSpeed={4}
          >
            {t.statsTitle}
          </GradientText>
        </h3>
        <div className={styles.statsGrid}>
          {t.stats.map((stat, index) => (
            <div 
              key={index}
              ref={el => statCardsRef.current[index] = el} 
              className={styles.statCard}
            >
              <div className={styles.statNumber}>
                {statsVisible ? (
                  <>
                    <CountUp
                      to={stat.value}
                      from={0}
                      duration={2}
                      delay={index * 0.15}
                      separator=","
                    />
                    {stat.suffix}
                    {stat.hasStar && <span className={styles.starIcon}>â­</span>}
                  </>
                ) : (
                  <>0{stat.suffix}</>
                )}
              </div>
              <div className={styles.statLabel}>{stat.label}</div>
              <div className={styles.statIcon}>{stat.icon}</div>
            </div>
          ))}
        </div>
      </div>
    </section>
  );
};

export default IndexSeccion6;
